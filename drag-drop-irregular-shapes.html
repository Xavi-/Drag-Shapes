<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <title>drag-drop-irregular-shapes</title>
    <script src="../jquery-1.2.6.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css" media="screen">
    #board, 
    #board-screen
    {
        width: 300px;
        height: 300px;
    }
    
    #board
    {
        border: 5px solid black;
        position: relative;
    }
    
    #board-screen
    {
        position: absolute;
        border: 0px;
        z-index: 999999;
    }
    
    .indicator
    {
        position: absolute;
        overflow: hidden;
        background-color: #F00;
        width: 3px;
        height: 3px;
        z-index: -1;
    }
    
    img.piece
    {
        border: 0px solid black;
        position: absolute;
        z-index: 1;
    }
</style>
</head>
<body id="drag-drop-irregular-shapes">
    <div id="board">
        <img id="board-screen" alt="board" src="./transparent.gif" usemap="#board-def" />
        <map id="board-def" name="board-def">
            <area shape="poly" coords="50,0,100,50,50,100,0,50" shape-id="1" adj-pieces="{'2': [0, 100]}" img-piece="diamond.png"/>
            <area shape="poly" coords="50,200,100,250,50,300,0,250" shape-id="2" adj-pieces="{'1': [0, -100]}" img-piece="diamond.png"/>
        </map>
    </div>
<script type="text/javascript" charset="utf-8">
var board = {};
var puzzle = {};

(function() {
    var makeShape = function(areaElem) {
        var points = [];
        var listeners = { move: [] };
        var boundBox = (function() {
            var minX = Number.POSITIVE_INFINITY, maxX = Number.NEGATIVE_INFINITY;
            var minY = Number.POSITIVE_INFINITY, maxY = Number.NEGATIVE_INFINITY;
            
            var coords = $(areaElem).attr("coords");
            var tempPts = coords.split(",");
            if(tempPts.length % 2) throw Error("Odd number of points in coords: " + coords)
            
            for(var i = 0; i < tempPts.length; i += 2) {
                var x = Number(tempPts[i]), y = Number(tempPts[i + 1]);
                
                points.push({ "x": x, "y": y });
                
                if (minX > x) minX = x;
                if (minY > y) minY = y;
                if (maxX < x) maxX = x;
                if (maxY < y) maxY = y;
            }
            
            return { x: minX, y: minY, 
                     width: maxX - minX, height: maxY - minY };
        })();
        
        var shape = {};
        // Returns object of the form {x: int, y: int, width: int, height: int};
        shape.getBoundingBox = function() { return boundBox; };
        
        shape.getElement = function() { return areaElem; };
        
        shape.bringForward = function() {
            $(areaElem).parent().prepend(areaElem);
        };
        
        shape.onMove = function(listener) {
            listeners.move.push(listener);
        };
        
         shape.onClick = function(listener) {
            $(areaElem).click(function(e) {
                listener.call(shape, e);
            });
        };
        
        shape.onMouseUp = function(listener) {
            $(areaElem).mouseup(function(e) {
                listener.call(shape, e);
            });
        }
        
        // Pos is the x, y coordinates of the upper left hand corner of the bounding box
        shape.move = function(pos, e) { 
            var diff = { x: pos.x - boundBox.x, y: pos.y - boundBox.y };
            
            var coords = [];
            for(var i = 0; i < points.length; i++) {
                points[i].x += diff.x; 
                points[i].y += diff.y;
                
                coords.push(points[i].x);
                coords.push(points[i].y);
            }
            
            boundBox.x = pos.x;
            boundBox.y = pos.y;
            
            $(areaElem).attr("coords", coords.join(","));
            
            for(var i = 0; i < listeners.move.length; i++) {
                listeners.move[i].call(shape, e);
            }
        };
                
        return shape;
    };
    
    board.create = function(boardId) {
        var shapes = {};
        
        var mouseIsDown = false; 
        var offset;
        var shapeMoving;
        
        $(document)
            .mouseup(function() { 
                mouseIsDown = false; 
                offset = {};
                shapeMoving = {};
                
                return false;
            })
            .mousemove(function(e) {
                if(!mouseIsDown) return false;
                
                var shape = shapes[$(shapeMoving).attr("shape-id")];
                shape.move({ x: e.pageX + offset.x, y: e.pageY + offset.y }, e);
                
                return false;
            });
        
        $("#" + boardId + " area")
            .each(function(i) {
                var id = $(this).attr("shape-id");
                shapes[id] = makeShape(this);
            })
            .mousedown(function(e) { 
                var boundBox = shapes[$(this).attr("shape-id")].getBoundingBox();
                
                offset = { x: boundBox.x - e.pageX, y: boundBox.y - e.pageY };
                mouseIsDown = true; 
                shapeMoving = this;
                
                return false; 
            });
        
        return shapes;
    };
    
    puzzle.create = function(shapes) {
        var threshold = 10;
        
        var addDisplayer = function(shape) {
            var img = new Image();
            img.src = $(shape.getElement()).attr("img-piece");
            $("#board").prepend(img);
            $(img)
                .addClass("piece")
                .css({ left: shape.getBoundingBox().x, top: shape.getBoundingBox().y });
            
            shape.onMove(function(e) {
                var box = this.getBoundingBox();
                $(img).css({ left: box.x, top: box.y });
            });
        };
        
        var addAdjacencyCheck = function(shape, adjList) {
            shape.onMouseUp(function(e) {
                var thisBox = this.getBoundingBox();
                 
                for (var id in adjList) {
                    if (!adjList[id]) continue;
                    
                    var thatBox = shapes[id].getBoundingBox();
                    
                    var truVec = { x: adjList[id][0], y: adjList[id][1] };
                    var vec = { x: thatBox.x - thisBox.x, y: thatBox.y - thisBox.y };
                    var diff = { x: Math.abs(vec.x - truVec.x), y: Math.abs(vec.y - truVec.y) };
                    
                    if (diff.x < threshold && diff.y < threshold) {
                        var setPos = { x: thatBox.x - truVec.x, y: thatBox.y - truVec.y };
                        
                        adjList[id] = null;
                        
                        this.move(setPos);
                        connectShapes(this, shapes[id], truVec);
                    }
                }
            });
        };
        
        var connectShapes = function(shape1, shape2, vec) {
            shape1.onMove(function(e) {
                var box1 = this.getBoundingBox();
                var box2 = shape2.getBoundingBox();
                var pos = { x: box1.x + vec.x, y: box1.y + vec.y };
                
                if(box2.x === pos.x && box2.y === pos.y) return;
                
                shape2.move(pos);
            });
            
            var negVec = { x: -vec.x, y: -vec.y };
            shape2.onMove(function(e) {
                var box2 = this.getBoundingBox();
                var box1 = shape1.getBoundingBox();
                var pos = { x: box2.x + negVec.x, y: box2.y + negVec.y };
                
                if(box1.x === pos.x && box1.y === pos.y) return;
                
                shape1.move(pos);
            });
        };
        
        for (var shapeId in shapes) {
            var adj = eval("(" + $(shapes[shapeId].getElement()).attr("adj-pieces") + ")");
            
            addAdjacencyCheck(shapes[shapeId], adj);
            
            addDisplayer(shapes[shapeId]);
        }
    };
    
    var shapes = board.create("board-def");
    puzzle.create(shapes);
})();
</script>
</body>
</html>